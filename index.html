<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shelnet Notes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-dark.min.css">
    <style>
        /* --- Base & Scrollbar --- */
        html {
            scrollbar-width: thin;
            scrollbar-color: #2196F3 #000000;
        }
        @supports selector(::-webkit-scrollbar) {
            ::-webkit-scrollbar { width: 8px; height: 8px; }
            ::-webkit-scrollbar-track { background: #000000; border: 1px solid rgba(255, 255, 255, 0.1); }
            ::-webkit-scrollbar-thumb { background: #2196F3; border-radius: 4px; }
            ::-webkit-scrollbar-thumb:hover { background: #4da1e6; }
            ::-webkit-scrollbar-thumb:active { background: #104875; }
            ::-webkit-scrollbar-corner { background: #000000; }
        }
        body {
            background-color: #0d1117;
            color: #c9d1d9;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
            overflow-y: scroll;
        }

        /* --- Terminal Header --- */
        #terminal-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background-color: #0d1117;
            border-bottom: 1px solid #30363d;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            box-shadow: 0 4px 20px rgba(0,0,0,0.6);
        }

        /* Row 1: Prompt & Command */
        .term-row-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background-color: #161b22;
            border-bottom: 1px solid #21262d;
            font-size: 13px;
        }

        .term-prompt {
            color: #00c950; /* Green prompt */
            font-weight: bold;
        }
        .term-path {
            color: #2196F3; /* Blue path */
        }

        .term-cmd-btn {
            font-size: 12px;
            color: #8b949e;
            cursor: pointer;
            text-decoration: none;
            padding: 2px 8px;
            border: 1px solid transparent;
            border-radius: 2px;
            transition: all 0.2s;
        }
        .term-cmd-btn:hover, .term-cmd-btn.active {
            color: #f0f6fc;
            background-color: #21262d;
            border-color: #8b949e;
        }

        /* Row 2: The Output Line */
        .term-row-bot {
            padding: 8px 15px;
            background-color: #0d1117;
            font-size: 13px;
            color: #8b949e;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            height: 20px;
            line-height: 20px;
        }

        .term-link {
            color: #58a6ff;
            text-decoration: none;
            cursor: pointer;
            margin: 0 2px;
        }
        .term-link:hover { text-decoration: underline; }
        .term-link.active { color: #f2cc60; font-weight: bold; text-decoration: none; } 
        
        .separator { color: #484f58; margin: 0 8px; }

        /* --- Content Area --- */
        .container {
            max-width: 980px;
            margin: 0 auto;
            padding: 30px 25px;
        }

        .markdown-body {
            background: #0d1117;
        }
        
        /* --- Search & List View --- */
        .search-container {
            margin-bottom: 20px;
            border-bottom: 1px solid #30363d;
            padding-bottom: 20px;
        }
        
        .term-input {
            width: 100%;
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 10px;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 14px;
            outline: none;
            border-radius: 6px;
        }
        .term-input:focus {
            border-color: #58a6ff;
            box-shadow: 0 0 0 3px rgba(88, 166, 255, 0.1);
        }

        .search-hint {
            font-size: 12px;
            color: #8b949e;
            margin-top: 8px;
            font-family: monospace;
        }

        .file-list { list-style: none; padding: 0; }
        .file-list li {
            padding: 8px 0;
            border-bottom: 1px solid #21262d;
            font-family: "SFMono-Regular", Consolas, "Liberation Mono", Menlo, Courier, monospace;
            font-size: 13px;
        }
        .file-list a {
            color: #c9d1d9;
            text-decoration: none;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }
        .file-list a:hover { color: #58a6ff; }
        .file-path-dim { color: #484f58; }

        #loading, #error {
            text-align: center;
            margin-top: 50px;
            font-family: monospace;
            color: #8b949e;
        }
        #error { color: #ff7b72; }
    </style>
</head>
<body>

    <header id="terminal-header">
        <div class="term-row-top">
            <span class="term-prompt">lui-gi@shelnet<span style="color:#c9d1d9">:</span><span class="term-path">~/notes</span></span>
            <a id="btn-all" class="term-cmd-btn" onclick="loadAllNotesView()">[ all notes ]</a>
        </div>
        
        <div id="term-output" class="term-row-bot">
            <span style="color:#484f58">...system_boot...</span>
        </div>
    </header>

    <div class="container">
        <div id="loading" style="display:none;">> executing_request...</div>
        <div id="error" style="display: none;"></div>
        <div id="content" class="markdown-body"></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify/dist/purify.min.js"></script>

    <script>
        const USER = 'lui-gi';
        const REPO = 'shelnet-notes';
        const BRANCH = 'main';

        // State
        let allNotesCache = []; 
        let recentNotesData = [];

        // --- CORE FUNCTIONS ---

        async function init() {
            try {
                // 1. Fetch File Tree
                const treeUrl = `https://api.github.com/repos/${USER}/${REPO}/git/trees/${BRANCH}?recursive=1`;
                const treeResp = await fetch(treeUrl);
                if (!treeResp.ok) throw new Error("Connection Refused: Tree Fetch Failed");
                const treeData = await treeResp.json();
                
                // 2. Filter & Sort by Filename (Descending Date)
                allNotesCache = treeData.tree
                    .filter(item => item.path.endsWith('.md') && !item.path.toLowerCase().includes('readme'))
                    .sort((a, b) => b.path.localeCompare(a.path)); // Newest date first

                // 3. Extract Top 3 for "Recent" Stack
                recentNotesData = allNotesCache.slice(0, 3).map(file => ({
                    path: file.path,
                    name: file.path.split('/').pop().replace('.md', ''),
                    url: `https://raw.githubusercontent.com/${USER}/${REPO}/${BRANCH}/${file.path}`
                }));

                renderTerminalLine();
                
                // Load the most recent note by default
                if (recentNotesData.length > 0) {
                    loadNote(recentNotesData[0].url, 0); 
                } else {
                    document.getElementById('content').innerHTML = "> No markdown notes found.";
                }

            } catch (err) {
                showError(err.message);
            }
        }

        function renderTerminalLine() {
            const container = document.getElementById('term-output');
            container.innerHTML = ''; 
            
            const prefix = document.createElement('span');
            prefix.innerText = "> recent: ";
            prefix.style.color = "#484f58";
            container.appendChild(prefix);

            recentNotesData.forEach((note, index) => {
                if (index > 0) {
                    const sep = document.createElement('span');
                    sep.className = 'separator';
                    sep.innerText = "|";
                    container.appendChild(sep);
                }

                const link = document.createElement('a');
                link.className = 'term-link';
                link.id = `nav-recent-${index}`;
                link.innerText = note.name;
                link.onclick = () => loadNote(note.url, index);
                
                container.appendChild(link);
            });
        }

        async function loadNote(rawUrl, activeIndex = -1) {
            updateActiveState(activeIndex);
            showLoading(true);
            document.getElementById('error').style.display = 'none';

            try {
                const resp = await fetch(rawUrl);
                if (!resp.ok) throw new Error("Failed to load payload");
                const text = await resp.text();
                
                document.getElementById('content').innerHTML = DOMPurify.sanitize(marked.parse(text));
            } catch (err) {
                showError("Content retrieval failed.");
            } finally {
                showLoading(false);
            }
        }

        // --- SEARCH & ALL NOTES VIEW ---

        function loadAllNotesView() {
            updateActiveState('all');
            const contentDiv = document.getElementById('content');
            contentDiv.innerHTML = ''; 

            // Search UI
            const searchContainer = document.createElement('div');
            searchContainer.className = 'search-container';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'term-input';
            input.placeholder = 'filter "search_query"';
            input.addEventListener('input', (e) => handleSearch(e.target.value));

            const hint = document.createElement('div');
            hint.className = 'search-hint';
            hint.innerText = "> Type to filter titles.";

            searchContainer.appendChild(input);
            searchContainer.appendChild(hint);
            contentDiv.appendChild(searchContainer);

            // Results Container
            const listContainer = document.createElement('div');
            listContainer.id = 'file-list-container';
            contentDiv.appendChild(listContainer);

            // Initial Render (All Files)
            renderFileList(allNotesCache);
        }

        function handleSearch(query) {
            const lowerQuery = query.toLowerCase();

            // Local Title Filter (Instant)
            const matches = allNotesCache.filter(item => 
                item.path.toLowerCase().includes(lowerQuery)
            );

            renderFileList(matches);
        }

        function renderFileList(files) {
            const container = document.getElementById('file-list-container');
            container.innerHTML = '';

            if (files.length === 0) {
                container.innerHTML = '<div style="color:#8b949e; font-family:monospace;">> No matches found.</div>';
                return;
            }

            const ul = document.createElement('ul');
            ul.className = 'file-list';

            files.forEach(file => {
                const li = document.createElement('li');
                
                const fileName = file.path.split('/').pop().replace('.md', '');
                const dirPath = file.path.includes('/') ? file.path.substring(0, file.path.lastIndexOf('/')) : './';

                const a = document.createElement('a');
                
                a.innerHTML = `<span>${fileName}</span> <span class="file-path-dim">${dirPath}</span>`;
                
                const rawUrl = `https://raw.githubusercontent.com/${USER}/${REPO}/${BRANCH}/${file.path}`;
                a.onclick = () => loadNote(rawUrl, -1);
                
                li.appendChild(a);
                ul.appendChild(li);
            });

            container.appendChild(ul);
        }

        // --- UTILS ---

        function updateActiveState(id) {
            document.querySelectorAll('.term-link').forEach(el => el.classList.remove('active'));
            document.getElementById('btn-all').classList.remove('active');
            
            if (id === 'all') {
                document.getElementById('btn-all').classList.add('active');
            } else if (id !== -1) {
                const el = document.getElementById(`nav-recent-${id}`);
                if (el) el.classList.add('active');
            }
        }

        function showLoading(isLoading) {
            document.getElementById('loading').style.display = isLoading ? 'block' : 'none';
        }

        function showError(msg) {
            const el = document.getElementById('error');
            el.innerText = `[ERR]: ${msg}`;
            el.style.display = 'block';
            document.getElementById('loading').style.display = 'none';
        }

        init();
    </script>
</body>
</html>